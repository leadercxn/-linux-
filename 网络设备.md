# 网络设备
## 框架
* 框架
    网络驱动的核心就是初始化 net_device 结构体中的各个成员变量，然后将初始化完成以后的 net_device 注册到 Linux 内核中。
    
    
## 数据结构
* 路径：`include/linux/netdevice.h`
* 数据结构: 
    net_device
    ```C
        struct net_device {
            char name[IFNAMSIZ];        //name 是网络设备的名字
            ...
            unsigned long mem_end;      //共享内存结束地址
            unsigned long mem_start;    //共享内存起始地址
            ...
            const struct net_device_ops *netdev_ops;    //netdev_ops 是网络设备的操作集函数，包含了一系列的网络设备操作回调函数
            const struct ethtool_ops *ethtool_ops;      //是网络管理工具相关函数集，用户空间网络管理工具会调用此结构体中的相关函数获取网卡状态或者配置网卡
            ...
            unsigned int flags;         //网络接口标志，标志类型定义在 include/uapi/linux/if.h 
            ...
            unsigned char dma;          //dma 是网络设备所使用的 DMA 通道，不是所有的设备都会用到 DMA
            unsigned int mtu;           //mtu 是网络最大传输单元，为 1500
            ...
            unsigned long last_rx;      //last_rx 是最后接收的数据包时间戳，记录的是 jiffies
            ...
            struct netdev_rx_queue *_rx;    //_rx 是接收队列
            unsigned int num_rx_queues;     //num_rx_queues 是接收队列数量，在调用 register_netdev 注册网络设备的时候会分配指定数量的接收队列
            unsigned int real_num_rx_queues;    //当前活动的队列数量
            ...
            struct netdev_queue *_tx ____cacheline_aligned_in_smp;  //发送队列
            unsigned int num_tx_queues;         //是发送队列数量，通过 alloc_netdev_mq 函数分配指定数量的发送队列
            unsigned int real_num_tx_queues;    //当前有效的发送队列数量
            struct Qdisc *qdisc;
            unsigned long tx_queue_len;
            ...
            unsigned long trans_start;          //最后的数据包发送的时间戳，记录的是 jiffies
            ...
        }
    ```
    + 内嵌的 网络设备操作结构体 `const struct net_device_ops *netdev_ops`,该结构体里面都是一些 `ndo_`开头的函数
        路径:   include/linux/netdevice.h
        ```C
            struct net_device_ops{
                int (*ndo_init) (struct net_device *dev);   // 第一次注册网络设备的时候会执行，虚拟网络设备可能会用
                void （*ndo_uninit） (struct net_device *dev);  //卸载网络设备的时候，此函数会执行

                int (*ndo_open) (struct net_device *dev);   // 打开网络设备的时候，此函数会执行，网络驱动程序需要实现此函数，非常重要！ 官方demo在此回调执行: 1. 使能网络外设时钟    2. 申请网络所使用的环形缓冲区   3. 初始化MAC外设    4. 绑定对应的PHY   5. 开启MAC   ...

                int (*ndo_stop) (struct net_device *dev);   // 关闭网络设备的时候会执行此函数, 官方demo在此回调: 1. 停止PHY 2. 停止发送功能  3. 关闭MAC

                netdev_tx_t (*ndo_start_xmit) (struct sk_buff *skb , struct net_device *dev);   // 当需要发送数据的时候，此函数会调用。 传参,*skb中保存了上层传递给网络驱动层的数据，即要发送的数据都在这。 若发送成功的话，此函数会返回 NETDEV_TX_OK;失败,返回 NETDEV_TX_BUSY,

                u16 (*ndo_select_queue) (struct net_device *dev,        // 支持多传输队列的时候选择哪个队列
                                         struct sk_buff *skb,
                                         void *accel_priv,
                                         select_queue_fallback_t fallback);
                ...
                void (*ndo_set_rx_mode) (struct net_device *dev);       // 用于改变地址过滤列表，根据 net_device 的 flags的成员变量来设置SOC的网络外设寄存器
                int (*ndo_set_mac_address) (struct net_device *dev,void *addr); //修改网卡的MAC地址,根据 net_device 的 dev_addr成员变量，将MAC地址写入到网络外设的硬件寄存器中
                int (*ndo_validate_addr) (struct net_device *dev);      // 验证MAC地址是否合法
                int (*ndo_do_ioctl) (struct net_device *dev,struct ifreq *ifr,int cmd); //用户程序调用ioctl函数会执行此函数
                ...
                int (*ndo_change_mtu) (struct net_device *dev,int new_mtu);     //更改MTU的值
                void (*ndo_tx_timeout) (struct net_device *dev);    //更改发送超时会执行此函数，一般是网路除了问题导致，一般会重启MAC或者重启PHY

                void (*ndo_poll_controller) (struct net_device *dev);   // 查询的当时来处理网卡的数据收发
                ...
                int (*ndo_set_features) (struct net_device *dev, net_features_t features);  //设置硬件的相关属性
                ...
            };
        ```


## API
1. 申请 net_device
    ```C
        #define alloc_netdev(sizeof_priv, name, name_assign_type, setup) 
            \ alloc_netdev_mqs(sizeof_priv, name, name_assign_typesetup, 1, 1)

        sizeof_priv:    似有数据块大小
        name:   设备名字
        setup:  回调函数，初始化设备后调用此函数
        txqs:   分配的发送队列数量
        rxqs:   分配的接收队列数量

        返回值:  成功:申请到的net_device指针，失败返回NULL
    ```

2. 删除 net_device
    ```C
        void free_netdev(struct net_device *dev);

        dev:    要释放掉的net_device指针
    ```

3. 注册 net_device
    ```C
        int register_netdev(struct net_device *dev)

        dev:    要注册的 net_device 指针
        返回值:  0注册成功   负值:注册失败
    ```

4. 注销 net_device
```C
    void unregister_netdev(struct net_device *dev)

    dev:    要注销的net_device指针
```

